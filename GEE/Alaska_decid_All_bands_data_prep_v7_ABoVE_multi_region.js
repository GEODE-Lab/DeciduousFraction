/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var above_mainland = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[-168.37923790218713, 65.2408171647917],
          [-166.94480612846922, 64.45743424194822],
          [-165.5502971944888, 63.979230670742936],
          [-163.71444966954596, 63.89895444690076],
          [-161.6571988321511, 64.14425487393778],
          [-161.83607174788017, 63.702550184881076],
          [-163.1954310653906, 63.27556836898275],
          [-164.813727112906, 63.25887642997687],
          [-165.3861468537719, 62.84370215212711],
          [-166.4020823323528, 61.74750746271635],
          [-166.10441234284235, 60.715140577691294],
          [-165.05921686783677, 60.0644979416448],
          [-164.19023777917874, 59.20004924555838],
          [-162.57141232213326, 59.12981498960252],
          [-162.5343715863013, 58.1041976515226],
          [-161.35261341801737, 58.10212790775863],
          [-159.46905402474522, 58.37539987460745],
          [-157.98394614672344, 57.88781063969518],
          [-158.90679550365934, 57.20825757845658],
          [-161.27619953895453, 56.20303695310627],
          [-160.97426487908325, 55.36549959344391],
          [-158.0838154203867, 55.534555950699385],
          [-155.05707702738738, 56.86900574982555],
          [-154.44900883370264, 55.86215321336319],
          [-150.1091634580926, 57.596615975047484],
          [-148.746812051059, 59.07588268445444],
          [-147.78371961724247, 59.287677322657224],
          [-146.2381722954716, 58.93947271633795],
          [-145.5524180395297, 59.53018953401393],
          [-144.72180938689792, 59.462808356358735],
          [-143.09348843768765, 59.50007900829224],
          [-142.00984981147508, 59.57821768116906],
          [-141.24492954559173, 59.36830256078763],
          [-139.80372074531778, 59.1886169307751],
          [-137.3573809750476, 58.15399172031739],
          [-136.26517414791, 57.223608895249946],
          [-135.33001047488426, 55.921338416547556],
          [-134.0887821113136, 54.29538624033502],
          [-132.16788312451848, 52.5475383074196],
          [-130.7199097760831, 50.878658517159074],
          [-126.86196446181657, 49.0920895812973],
          [-123.24527533934446, 48.02184800934644],
          [-115.87783276350137, 48.76616074003197],
          [-113.66518404431793, 48.809022283139974],
          [-110.89122162571613, 48.46175561004258],
          [-106.81627691809172, 48.65602257634772],
          [-103.00710358136769, 48.54691463067816],
          [-101.51856408128447, 48.63696531651406],
          [-99.50220754096466, 48.84108819155404],
          [-99.5972460452519, 48.999737897072755],
          [-98.76629647897192, 48.82940551962333],
          [-97.62935882292828, 48.56760449089019],
          [-96.92454788995911, 48.7180290300142],
          [-96.13496189325303, 48.57764696317806],
          [-93.98734561467052, 48.228034591391946],
          [-87.59951983305314, 47.241668549953694],
          [-85.93809732221695, 46.17397201357205],
          [-84.03721746424048, 44.54958012378298],
          [-83.32294550108094, 41.301999651125186],
          [-70.4222000700272, 40.81425131188018],
          [-62.63636857487097, 43.21242228118571],
          [-49.35488034340091, 45.97910232622649],
          [-63.48894343215136, 61.31250229989989],
          [-59.927349864775124, 66.20255568527264],
          [-63.181218324358554, 68.5894288206514],
          [-71.92239859888622, 68.45069069997581],
          [-79.46554706839117, 64.16005584320573],
          [-79.55425071695515, 58.306316593772436],
          [-77.26318356284503, 56.56585857224743],
          [-81.74097808953451, 55.5437734832309],
          [-88.86078838247175, 56.98138058993331],
          [-90.39638426581433, 57.49970306021302],
          [-91.92821650718798, 57.44988720866181],
          [-92.8136792976785, 59.05996827637706],
          [-93.73276988238945, 59.08089918915811],
          [-94.17347726342945, 59.5712469530327],
          [-93.13515421767875, 61.257337658743495],
          [-89.69590327659512, 63.21854708098948],
          [-88.29971065651569, 63.57371243195549],
          [-86.64921454880755, 64.68357808590608],
          [-86.22062634209624, 65.45846516031452],
          [-85.30650812370016, 65.80308651465865],
          [-82.37536979751474, 65.70146931100638],
          [-80.55456985133077, 66.88331403455605],
          [-80.79529585041877, 68.33136133905865],
          [-81.6959329448024, 69.87200522251324],
          [-85.54337789402484, 70.07333325988594],
          [-87.80362309265786, 69.43418816781985],
          [-90.6534608942369, 70.19701453262078],
          [-91.38137135427161, 71.93578511677667],
          [-89.9302635075158, 73.45484500125022],
          [-89.59819240826926, 74.1483243938073],
          [-92.48210142159985, 74.50788348208553],
          [-93.64078806093994, 75.55126461683231],
          [-96.56632198042081, 75.96385518839367],
          [-96.84423108800127, 76.58228466296576],
          [-98.43966996061636, 77.62627445271583],
          [-99.02999599605693, 78.4001621114227],
          [-101.56739171004949, 79.04083991210153],
          [-103.78518076292607, 79.29037630610053],
          [-106.73302865651635, 79.42290642135833],
          [-112.9089164362689, 78.92972446751013],
          [-118.3082229941034, 78.07224739259347],
          [-122.02774175998371, 77.0928005993555],
          [-123.67245938183333, 76.18033266208785],
          [-125.7980730071705, 75.18176431451269],
          [-125.62297373594208, 73.89648738075918],
          [-126.01362231925492, 72.8385498903379],
          [-127.27565267847626, 71.63040627998767],
          [-126.4916955838724, 70.87466996436109],
          [-130.10727202164946, 70.77476674096954],
          [-134.03142002887603, 69.71568077616695],
          [-137.38908415665958, 69.39751576097011],
          [-144.57576758626078, 70.33302214472302],
          [-155.0256170569025, 71.40241695241527],
          [-157.5989802441984, 71.33664111848479],
          [-164.95657595541377, 69.58466605245158],
          [-167.55206790812736, 68.35172559944486],
          [-164.64229563790371, 67.0363547690636],
          [-165.47865435894488, 66.53844990972605],
          [-168.02327897506717, 65.76585533372307]]]),
    zone1 = /* color: #253bd6 */ee.Geometry.Polygon(
        [[[-141.328125, 61.73152565113397],
          [-136.98804910875856, 61.55754198059565],
          [-130.25390625, 61.64816245852395],
          [-118.388671875, 61.64816245852392],
          [-109.775390625, 61.68987220045999],
          [-109.248046875, 79.88973717174639],
          [-124.8386769987568, 75.69839539226707],
          [-127.29971233251035, 73.05352679871419],
          [-127.76447139555012, 71.18241823975474],
          [-136.57574846816965, 69.76160143677127],
          [-141.416015625, 70.19999407534661]]]),
    zone2 = /* color: #98ff00 */ee.Geometry.Polygon(
        [[[-109.599609375, 79.87429692631285],
          [-110.390625, 61.56457388515459],
          [-102.12890625, 61.56457388515459],
          [-92.63671875, 61.56457388515459],
          [-80.33203125, 61.5226949459836],
          [-58.88671875, 61.18562468142283],
          [-60.75359838478971, 66.69128444147464],
          [-68.115234375, 72.5544984966527],
          [-79.46268521182355, 75.82654435670185],
          [-90.3515625, 76.59854506890709],
          [-95.44188013163352, 78.96511286239308],
          [-100.76670066607682, 79.22444104665169]]]),
    zone3 = /* color: #0b4a8b */ee.Geometry.Polygon(
        [[[-138.076171875, 58.031372421776396],
          [-134.208984375, 53.17311920264064],
          [-124.892578125, 47.694974341862824],
          [-118.388671875, 48.574789910928885],
          [-109.775390625, 48.516604348867475],
          [-109.86328125, 50.56928286558243],
          [-109.86328125, 62.103882522897855],
          [-112.5, 61.98026726504401],
          [-119.1796875, 61.93895042666061],
          [-125.33203125, 61.93895042666061],
          [-130.693359375, 61.85614879566797],
          [-136.494140625, 61.85614879566797],
          [-140.44921875, 61.77312286453145],
          [-141.416015625, 61.83541335794044],
          [-141.44003213100132, 59.30091542995645]]]),
    zone4 = /* color: #ffc82d */ee.Geometry.Polygon(
        [[[-102.0821983401313, 48.343732182918444],
          [-96.28723300378971, 48.39859262718133],
          [-92.33619096396069, 47.69095915583918],
          [-87.81162057295387, 46.796920302596604],
          [-83.42980022947569, 41.17566199379897],
          [-75.21556264793293, 43.47894951694195],
          [-74.1337105671289, 44.314986738924844],
          [-71.14921369191927, 44.75275797950917],
          [-69.01569850009935, 46.123823821620945],
          [-65.54991505307743, 43.04775213049375],
          [-59.10953400025778, 45.63721256282798],
          [-52.28045548936922, 46.41967042543777],
          [-53.408531066369335, 52.30015394449034],
          [-57.663708890390865, 54.94669881803222],
          [-61.97826979439657, 60.00768963705834],
          [-62.701459572887245, 61.781130426408225],
          [-74.52581787486929, 61.918873824879256],
          [-77.50806588283604, 61.91829272622474],
          [-81.63042692545287, 61.710622267579524],
          [-88.99818618459153, 61.91763439088837],
          [-93.99771914137938, 61.918135426805065],
          [-98.99746257904286, 61.83642058422084],
          [-103.64659209642855, 61.75483188993627],
          [-110.57640085568312, 61.92313920977558],
          [-110.77515484366108, 48.58088542654131]]]),
    zone5 = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-167.783203125, 68.07330474079025],
          [-164.970703125, 66.96447630005638],
          [-168.486328125, 66.26685631430843],
          [-168.22265625, 64.54844014422517],
          [-163.740234375, 63.89873081524393],
          [-166.728515625, 63.11463763252092],
          [-168.3984375, 59.355596110016315],
          [-159.78515625, 57.326521225217064],
          [-165.498046875, 55.727110085045986],
          [-164.70703125, 53.225768435790194],
          [-158.818359375, 54.87660665410869],
          [-153.193359375, 55.7765730186677],
          [-152.490234375, 57.27904276497778],
          [-149.4140625, 58.99531118795094],
          [-145.810546875, 59.977005492196],
          [-140.7568359375, 59.153403092050375],
          [-140.90746584324359, 65.67611691802753],
          [-140.888671875, 70.1851027549897],
          [-146.162109375, 70.55417853776078],
          [-154.248046875, 71.49703690095419],
          [-160.3125, 71.24435551310674],
          [-167.255859375, 68.97416358340674]]]),
    image = ee.Image("users/masseyr44/ak_decid_1995_pred"),
    image2 = ee.Image("users/masseyr44/ak_decid_2000_pred"),
    image3 = ee.Image("users/masseyr44/ak_decid_2005_pred"),
    image4 = ee.Image("users/masseyr44/ak_decid_2010_pred"),
    image5 = ee.Image("users/masseyr44/ak_decid_2015_pred"),
    table = ee.FeatureCollection("users/masseyr44/decid/ABoVE_Study_Domain"),
    tc2010 = ee.Image("users/masseyr44/decid/hansen_tc_2010_mosaic_vis");
/***** End of imports. If edited, may not auto-convert in the playground. *****/
/*
Map.addLayer(image, {min:0,max:100,palette:'006400,ffff00'},'1995')
Map.addLayer(image2, {min:0,max:100,palette:'006400,ffff00'},'2000')
Map.addLayer(image3, {min:0,max:100,palette:'006400,ffff00'},'2005')
Map.addLayer(image4, {min:0,max:100,palette:'006400,ffff00'},'2010')
Map.addLayer(image5, {min:0,max:100,palette:'006400,ffff00'},'2015')
*/


var start_year = 2007
var end_year = 2012
var year = 2010
var bounds = above_mainland
var zone_name = 'all'

var L = 0.5
var index = 'NDVI'
var min_pctl = 75
var max_pctl = 95

var vis_band = 'NDVI'

var startJulian1 = 90;
var endJulian1 = 165;
var startJulian2 = 180;
var endJulian2 = 240;
var startJulian3 = 255;
var endJulian3 = 330;

var internal_bands = ee.List(['BLUE', 'GREEN', 'RED', 'NIR', 'SWIR1', 'SWIR2','PIXEL_QA', 'RADSAT_QA','NDVI', 'NDWI', 'NBR', 'VARI', 'SAVI'])
var bands = ee.List(['BLUE', 'GREEN', 'RED', 'NIR', 'SWIR1', 'SWIR2', 'NDVI', 'NDWI', 'NBR', 'VARI', 'SAVI'])

//************************************************

var startDate = ee.Date.fromYMD(start_year,1,1);
var endDate = ee.Date.fromYMD(end_year,12,31);

//define all image collections to use
var ls5 = ee.ImageCollection("LANDSAT/LT05/C01/T1_SR"); 
var ls7 = ee.ImageCollection("LANDSAT/LE07/C01/T1_SR");
var ls8 = ee.ImageCollection("LANDSAT/LC08/C01/T1_SR");

//merge all collections
var all_images=ls5.merge(ls7).merge(ls8)
print(all_images.first())

//************************************************

//normalized difference vegetation index
var ndvi_calc=function(img){
  return img.normalizedDifference(['NIR', 'RED'])
            .select([0],['NDVI'])
            .multiply(10000)
            .toInt16()
}

// Visible Atmospherically Resistant Index 
var vari_calc=function(img){
  return (img.select(['RED']).subtract(img.select(['GREEN'])))
          .divide(img.select(['RED']).add(img.select(['GREEN'])).subtract(img.select(['BLUE'])))
            .select([0],['VARI'])
            .multiply(10000)
            .toInt16()
}

//normalized difference water index
var ndwi_calc=function(img){
  return img.normalizedDifference(['NIR', 'SWIR2'])
            .select([0],['NDWI'])
            .multiply(10000)
            .toInt16()
}

//normalized burn ratio
var nbr_calc=function(img){
  return img.normalizedDifference(['NIR', 'SWIR1'])
            .select([0],['NBR'])
            .multiply(10000)
            .toInt16()
}

//soil adjusted vegetation index
var savi_calc=function(img){
  return (img.select(['NIR']).subtract(img.select(['RED'])).multiply(1+L))
      .divide(img.select(['NIR']).add(img.select(['RED'])).add(L))
            .select([0],['SAVI'])
            .multiply(10000)
            .toInt16()
}

//function to add indices to an image
//NDVI, NDWI, VARI, NBR, SAVI
var addIndices=function(in_image){
  in_image = in_image.float().divide(10000.0)
  return in_image.addBands(ndvi_calc(in_image))
                 .addBands(ndwi_calc(in_image))
                 .addBands(vari_calc(in_image))
                 .addBands(nbr_calc(in_image))
                 .addBands(savi_calc(in_image))
                 .toInt16()
}


// add suffix to all band names
var add_suffix = function(in_image, suffix_str){
  var bandnames = in_image.bandNames().map(function(elem){return ee.String(elem).toLowerCase().cat('_').cat(suffix_str)})
  var nb = bandnames.length()
  return in_image.select(ee.List.sequence(0, ee.Number(nb).subtract(1)), bandnames)
}

//method to correct Landsat 8 based on Landsat 7 reflectance. 
//This method scales the SR reflectance values to match LS7 reflectance
//The returned values are generally lower than input image
var LS8_SR_corr = function(img){
  return img.select(['B2'],['BLUE']).float().multiply(0.8850).add(183).int16()
            .addBands(img.select(['B3'],['GREEN']).float().multiply(0.9317).add(123).int16())
            .addBands(img.select(['B4'],['RED']).float().multiply(0.9372).add(123).int16())
            .addBands(img.select(['B5'],['NIR']).float().multiply(0.8339).add(448).int16())
            .addBands(img.select(['B6'],['SWIR1']).float().multiply(0.8639).add(306).int16())
            .addBands(img.select(['B7'],['SWIR2']).float().multiply(0.9165).add(116).int16())
            .addBands(img.select(['pixel_qa'],['PIXEL_QA']).int16())
            .addBands(img.select(['radsat_qa'],['RADSAT_QA']).int16())
            .copyProperties(img)
            .copyProperties(img, ['system:time_start','system:time_end', 'system:index', 'system:footprint'])
}


//this method renames LS5 and LS7 bands and corrects LS8 bands using LS8_corr()
//this method should be used with SR only
var LS_SR_band_correction = function(img){
    return ee.Algorithms.If( 
      
      ee.String(img.get('SATELLITE')).compareTo('LANDSAT_8'),
      
        ee.Image(img.select(['B1','B2','B3','B4','B5','B7', 'pixel_qa', 'radsat_qa'],
                            ['BLUE', 'GREEN', 'RED', 'NIR', 'SWIR1', 'SWIR2', 'PIXEL_QA', 'RADSAT_QA'])
                    .int16()
                    .copyProperties(img)
                    .copyProperties(img, ['system:time_start', 'system:time_end', 'system:index', 'system:footprint'])), 
      
        ee.Image(LS8_SR_corr(img))
                    
      )}

//method to calcluate clear mask based on pixel_qa and radsat_qa bands
var LS_SR_only_clear = function(image) {
    var clearBit = 1;
    var clearMask = Math.pow(2, clearBit);
    var qa = image.select('PIXEL_QA');
    var qa_mask = qa.bitwiseAnd(clearMask);
    
    var ra = image.select('RADSAT_QA')
    var ra_mask = ra.eq(0)
    
    return ee.Image(image.updateMask(qa_mask).updateMask(ra_mask));
};



//make collections based on given parameters
function getLandsatImages(collection, bounds, startDate,endDate,startJulian,endJulian){  
  return ee.ImageCollection(collection)
          .filterDate(startDate,endDate)
          .filter(ee.Filter.calendarRange(startJulian,endJulian))
          .filterBounds(bounds)
          .map(LS_SR_band_correction)
          .map(LS_SR_only_clear)
          .map(addIndices)
          //.map(function(img){return img.addBands(img.normalizedDifference(['B4','B3']).select([0],['NDVI']))})
}

//function to make pctl th value composite
var maxvalcompNDVI = function(collection) {
  var index_band = collection.select(index)
  .reduce(ee.Reducer.percentile([min_pctl]))
  var withDist = collection.map(function(image) {
    return image.addBands(image.select(index).subtract(index_band)
    .abs().multiply(-1).rename('quality'))
  })
  return withDist.qualityMosaic('quality')
}

var interval_mean = function(collection){
  var temp_img = ee.ImageCollection(collection).reduce(ee.Reducer.intervalMean(min_pctl, max_pctl))
  return temp_img.select(ee.List.sequence(0, internal_bands.length().subtract(1)), internal_bands)
}


var elevation = ee.Image('USGS/GMTED2010')
var slope = ee.Terrain.slope(elevation).multiply(10000)
var aspect = ee.Terrain.aspect(elevation)

var topo_image = elevation.addBands(slope).addBands(aspect).select([0, 1, 2],
                                                               ['elevation', 'slope', 'aspect']).int16()
                                                               

function makeLS(bounds){
  var allImages1 = getLandsatImages(all_images, bounds, startDate,endDate,startJulian1,endJulian1)
  var allImages2 = getLandsatImages(all_images, bounds, startDate,endDate,startJulian2,endJulian2)
  var allImages3 = getLandsatImages(all_images, bounds, startDate,endDate,startJulian3,endJulian3)

  var imgSeason1 = add_suffix(maxvalcompNDVI(allImages1).select(bands), '1');
  var imgSeason2 = add_suffix(maxvalcompNDVI(allImages2).select(bands), '2');
  var imgSeason3 = add_suffix(maxvalcompNDVI(allImages3).select(bands), '3');
  
  //var imgSeason1= maxvalcompNDVI(allImages1,bounds).select(['NDVI']);
  //var imgSeason2= maxvalcompNDVI(allImages2,bounds).select(['NDVI']);
  //var imgSeason3= maxvalcompNDVI(allImages3,bounds).select(['NDVI']);
  
  return imgSeason1.addBands(imgSeason2).addBands(imgSeason3).addBands(topo_image)
}


var output_img = makeLS(bounds)
print(output_img)

var tree_thresh = 20

//Map.addLayer(table, {color:'ff0000'})

var tc = tc2010.updateMask(tc2010.gt(tree_thresh)).multiply(0).add(1)
var data_disp = output_img.select(['nir_1']).multiply(0).add(1)
var data_diff = tc.unmask().subtract(data_disp.unmask())

//Map.addLayer(tc, {palette:'ff0000'})
//Map.addLayer(data_disp,{},'output')


// green - where data is available but landcover is non tree cover
// red - where land cover is tree over and data is not available
Map.addLayer(data_diff.updateMask(data_diff.neq(0)),{palette:'00ff00,ff0000'},'data_diff')


//Map.addLayer(output_img.select([vis_band]),{min:0, max:10000, palette:"2e8b57,fff44f"},'output')

var out_name = 'ak_can_75pctl_SR_NDVI_tc_' + zone_name + '_' + year                         
print(out_name);
/*
Export.image.toDrive({
  image: output_img,
  description: out_name,
  folder:'ABoVE_data_Can2',
  fileNamePrefix:  out_name,
  region: bounds,
  scale:30,
  crs:'EPSG:4326',
  maxPixels:1e13,
});
*/
Export.image.toCloudStorage({
  image: output_img,
  description: out_name,
  bucket:'masseyr44_store1',
  fileNamePrefix:  'gee_output/' + out_name,
  region: bounds,
  scale:30,
  crs:'EPSG:4326',
  maxPixels:1e13,
});



