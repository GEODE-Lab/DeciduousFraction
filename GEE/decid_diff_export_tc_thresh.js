/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var above_mainland = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-141.240234375, 69.96043926902489],
          [-141.328125, 60.02095215374802],
          [-137.373046875, 58.81374171570781],
          [-135.615234375, 59.085738569819505],
          [-130.78125, 56.17002298293205],
          [-128.49609375, 55.17886766328199],
          [-128.14453125, 52.5897007687178],
          [-124.1015625, 50.17689812200107],
          [-119.619140625, 51.013754657188215],
          [-114.2578125, 50.79204706440687],
          [-112.236328125, 53.48804553605621],
          [-105.29296875, 52.48278022207823],
          [-100.458984375, 49.83798245308484],
          [-98.26171875, 50.401515322782366],
          [-96.50390625, 48.516604348867475],
          [-93.8671875, 49.781264058178344],
          [-94.306640625, 52.74959372674114],
          [-87.890625, 56.80087831233044],
          [-90.087890625, 57.657157596582984],
          [-91.845703125, 57.562995459387146],
          [-92.373046875, 59.0405546167585],
          [-93.955078125, 59.31076795603884],
          [-92.98828125, 61.312451574838214],
          [-88.681640625, 63.704722429433225],
          [-85.869140625, 64.8115572502203],
          [-85.166015625, 65.80277639340238],
          [-81.650390625, 66.26685631430843],
          [-80.33203125, 67.57571741708057],
          [-81.2109375, 68.13885164925574],
          [-80.33203125, 69.53451763078358],
          [-84.55078125, 70.17020068549206],
          [-86.572265625, 70.22974449563029],
          [-86.572265625, 68.72044056989829],
          [-89.82421875, 69.80930869552193],
          [-91.40625, 71.04552881933586],
          [-92.4609375, 71.85622888185527],
          [-93.53259798384272, 72.11510244593408],
          [-95.888671875, 71.96538769913127],
          [-97.03125, 71.21607526596132],
          [-97.32088162521228, 70.27117421737441],
          [-98.6572265625, 70.07307475707388],
          [-100.283203125, 69.09993967425089],
          [-99.42626953125, 68.29377944277815],
          [-101.22802734375, 68.10610151896537],
          [-104.26025390625, 68.56038368664157],
          [-105.6884765625, 68.97416358340674],
          [-106.94091796875, 68.98204571755964],
          [-109.4677734375, 68.4072675680943],
          [-111.90673828125, 68.12248241161676],
          [-113.466796875, 68.36680109391402],
          [-114.697265625, 68.98992503056704],
          [-117.57568359375, 69.34158817053792],
          [-122.8271484375, 70.31133703000764],
          [-129.3310546875, 70.78690984117928],
          [-133.13232421875, 69.97549253616164],
          [-136.47216796875, 69.4575536150494],
          [-138.75732421875, 69.7561553934614]]]),
    geometry1 = /* color: #253bd6 */ee.Geometry.Polygon(
        [[[-144.4921875, 61.77312286453145],
          [-136.98804910875856, 61.55754198059565],
          [-130.25390625, 61.64816245852395],
          [-118.388671875, 61.64816245852392],
          [-109.775390625, 61.68987220045999],
          [-109.51171875, 71.91088787611525],
          [-125.62979045751035, 72.18735586859609],
          [-143.525390625, 71.55274065141299]]]),
    geometry2 = /* color: #98ff00 */ee.Geometry.Polygon(
        [[[-110.126953125, 71.96538769913127],
          [-110.390625, 61.56457388515459],
          [-102.12890625, 61.56457388515459],
          [-92.63671875, 61.56457388515459],
          [-80.33203125, 61.5226949459836],
          [-73.740234375, 61.5226949459836],
          [-72.94921875, 71.9653876991313],
          [-83.583984375, 71.96538769913127]]]),
    geometry3 = /* color: #0b4a8b */ee.Geometry.Polygon(
        [[[-145.37109375, 49.83798245308484],
          [-134.12109375, 50.007739014636876],
          [-124.453125, 49.83798245308484],
          [-118.30078125, 50.007739014636876],
          [-109.775390625, 49.781264058178344],
          [-109.86328125, 50.56928286558243],
          [-109.86328125, 62.103882522897855],
          [-112.5, 61.98026726504401],
          [-119.1796875, 61.93895042666061],
          [-125.33203125, 61.93895042666061],
          [-130.693359375, 61.85614879566797],
          [-136.494140625, 61.85614879566797],
          [-140.44921875, 61.77312286453145],
          [-144.931640625, 61.81466389468391]]]),
    geometry4 = /* color: #ffc82d */ee.Geometry.Polygon(
        [[[-101.42578125, 49.09545216253482],
          [-95.712890625, 48.80686346108517],
          [-91.7578125, 48.40003249610686],
          [-82.85737777497957, 48.39066580532871],
          [-74.091796875, 48.63290858589534],
          [-73.916015625, 61.98026726504401],
          [-76.904296875, 61.98026726504401],
          [-81.03515625, 61.77312286453145],
          [-88.41796875, 61.98026726504401],
          [-93.427734375, 61.98026726504401],
          [-98.4375, 61.897577621605016],
          [-103.095703125, 61.81466389468391],
          [-110.0390625, 61.98026726504401],
          [-110.302734375, 48.980216985374994]]]),
    zone5 = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-167.783203125, 68.07330474079025],
          [-164.970703125, 66.96447630005638],
          [-168.486328125, 66.26685631430843],
          [-168.22265625, 64.54844014422517],
          [-163.740234375, 63.89873081524393],
          [-166.728515625, 63.11463763252092],
          [-168.3984375, 59.355596110016315],
          [-159.78515625, 57.326521225217064],
          [-165.498046875, 55.727110085045986],
          [-164.70703125, 53.225768435790194],
          [-158.818359375, 54.87660665410869],
          [-153.193359375, 55.7765730186677],
          [-152.490234375, 57.27904276497778],
          [-149.4140625, 58.99531118795094],
          [-145.810546875, 59.977005492196],
          [-140.80078125, 59.355596110016315],
          [-140.361328125, 70.22974449563029],
          [-146.162109375, 70.55417853776078],
          [-154.248046875, 71.49703690095419],
          [-160.3125, 71.24435551310674],
          [-167.255859375, 68.97416358340674]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var zone1 = above_mainland.intersection(geometry1)
var zone2 = above_mainland.intersection(geometry2)
var zone3 = above_mainland.intersection(geometry3)
var zone4 = above_mainland.intersection(geometry4)

 
var ls5 = ee.ImageCollection("LANDSAT/LC08/C01/T1_SR"); 
var ls7 = ee.ImageCollection("LANDSAT/LE07/C01/T1_SR");


var lsf = require('users/masseyr44/modules:landsat/LS_Util1');


var above_images=ls5.merge(ls7)


function toFloat(img){
  return img.float().divide(10000.0)}


function addIndices(in_image){
  
  
  function ndvi_calc(img){
    img=img.toFloat()
    return img.normalizedDifference(['NIR', 'RED'])
              .select([0],['NDVI'])
              .multiply(10000)
  }
  
  
  function nbr_calc(img){
    img=img.toFloat()
    return img.normalizedDifference(['NIR', 'SWIR2'])
              .select([0],['NBR'])
              .multiply(10000)
  }
  
  function ndwi_calc(img){
    img=img.toFloat()
    return img.normalizedDifference(['NIR', 'SWIR1'])
              .select([0],['NDWI'])
              .multiply(10000)
  }
  
  function ratio57_calc(img){
    img=img.toFloat()
    return img.select(['SWIR1']).divide(img.select(['SWIR2']))
        .select([0],['RATIO57'])
              .multiply(10000)
  }
  
  function nd57_calc(img){
    img=img.toFloat()
    return img.normalizedDifference(['SWIR1', 'SWIR2'])
              .select([0],['ND57'])
              .multiply(10000)
  }
  function nmdi_calc(img){
    img=img.toFloat()
    return (img.select(['NIR']).subtract(img.select(['SWIR1']).subtract(img.select(['SWIR2']))))
          .divide(img.select(['NIR']).add(img.select(['SWIR1']).add(img.select(['SWIR2']))))
              .select([0],['NMDI'])
              .multiply(10000)
  }
  
  in_image = in_image.addBands(ndvi_calc(in_image));
  in_image = in_image.addBands(ndwi_calc(in_image));
  in_image = in_image.addBands(ratio57_calc(in_image));
  in_image = in_image.addBands(nd57_calc(in_image));
  in_image = in_image.addBands(nbr_calc(in_image));
  in_image = in_image.addBands(nmdi_calc(in_image));
  return in_image;
}

function getLandsatImages(collection, bounds, startDate,endDate,startJulian,endJulian){  
  return ee.ImageCollection(collection)
          .filterDate(startDate,endDate)
          .filter(ee.Filter.calendarRange(startJulian,endJulian))
          .filterBounds(bounds)
          .map(lsf.LS_SR_rename_bands)
          .map(lsf.LS_SR_only_clear)
          .map(toFloat)
          .map(addIndices)
          

}

function maxvalcompNDVI(collection,bounds){
  return collection.qualityMosaic('NDVI').clip(bounds)
}

var period_length=1
var start_year=2008
var end_year=2012

var startDate = ee.Date.fromYMD(start_year,1,1);
var endDate = ee.Date.fromYMD(end_year,12,31);



var startJulian1 = 136;
var endJulian1 = 180;
var startJulian2 = 181;
var endJulian2 = 225;
var startJulian3 = 226;
var endJulian3 = 273;


function makeLS(bounds){
var allImages1 = getLandsatImages(above_images, bounds, startDate,endDate,startJulian1,endJulian1);
var allImages2 = getLandsatImages(above_images, bounds, startDate,endDate,startJulian2,endJulian2);
var allImages3 = getLandsatImages(above_images, bounds, startDate,endDate,startJulian3,endJulian3);


var imgSeason1= maxvalcompNDVI(allImages1,bounds).select(['NIR','SWIR1','NDVI','NDWI','NBR','RATIO57','ND57','NMDI']);
var imgSeason2= maxvalcompNDVI(allImages2,bounds).select(['NIR','SWIR1','NDVI','NDWI','NBR','RATIO57','ND57','NMDI']);
var imgSeason3= maxvalcompNDVI(allImages3,bounds).select(['NIR','SWIR1','NDVI','NDWI','NBR','RATIO57','ND57','NMDI']);
return imgSeason1.addBands(imgSeason2).addBands(imgSeason3)}


//****************************
var out_zone = zone5
//****************************


var output_img = makeLS(out_zone)
print(output_img)
Map.addLayer(output_img,{},'output')

var out_name = 'ABoVE_img_am_2010_z5'                            
print(output_img);
Export.image.toDrive({
  image: output_img,
  description: out_name,
  folder:'ABoVE_data_Can',
  fileNamePrefix:  out_name,
  region: out_zone,
  scale:30,
  crs:'EPSG:4326',
  maxPixels:1e13,
});
